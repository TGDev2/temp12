<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Recherche Abarak</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.9.0/localforage.min.js"></script>
</head>

<body>
    <header>
        <h1>Recherche Abarak</h1>
    </header>

    <div class="container">
        <div id="message" class="green"></div>
        <div id="itemCount"></div>
        <div id="buttons">
            <button onclick="loadData()">Recharger</button>
            <button onclick="clearData()">Vider</button>
            <button onclick="toggleLocalData()" id="toggleButton">Afficher les données locales</button>
        </div>

        <!-- Localisation -->
        <div id="localisationContainer">
            <label for="localisationSelect">Localisation :</label>
            <select id="localisationSelect" onchange="onLocalisationChange()">
                <option value="1">Lieu 1 (Liste 1)</option>
                <option value="2">Lieu 2 (Liste 2)</option>
                <option value="3">Lieu 3 (Liste 3)</option>
                <option value="4">Lieu 4 (Toutes les listes)</option>
            </select>
        </div>

        <form id="uploadForm">
            <input type="file" id="priceImage" accept="image/*">
            <button type="button" onclick="uploadImage()">Télécharger l'image</button>
            <input type="text" id="articleId" placeholder="ID de l'article">
        </form>

        <select id="categorySelect" onchange="filterByCategory()">
            <option value="">-- Sélectionner une catégorie --</option>
        </select>

        <input type="text" id="searchInput" placeholder="Rechercher un article">
        <button onclick="searchArticle()">Rechercher</button>

        <div id="results"></div>
    </div>

    <footer>
        &copy; 2024 Abarak
    </footer>

    <script>
        let isDataVisible = false;

        // ---------- Helpers Localisation ----------
        function getSelectedLocation() {
            const sel = document.getElementById('localisationSelect');
            return sel ? sel.value : '1';
        }

        function getSuffixForLocation(location) {
            // Lieu 1 => pas de suffixe ; Lieu 2 => " 2" ; Lieu 3 => " 3"
            if (location === '2') return ' 2';
            if (location === '3') return ' 3';
            return ''; // Lieu 1, ou par défaut
        }

        function onLocalisationChange() {
            const value = getSelectedLocation();
            localforage.setItem('localisation', value).then(() => {
                refreshCurrentView();
            }).catch(() => {
                // même si échec de persistance, on rafraîchit l'affichage
                refreshCurrentView();
            });
        }

        function loadLocalisationFromStorage() {
            return localforage.getItem('localisation').then(value => {
                const sel = document.getElementById('localisationSelect');
                if (sel) {
                    sel.value = value ? String(value) : '1';
                }
            });
        }

        // ---------- Suffixe d'affichage ----------
        function appendSuffixToValue(value, suffix) {
            // Rendre sûr pour tout type : on affiche sous forme de string + suffix
            if (value === null || value === undefined) return '' + suffix;
            return String(value) + suffix;
        }

        // ---------- Compteur ----------
        function updateItemCount() {
            localforage.getItem('articles').then(articles => {
                const itemCountDiv = document.getElementById('itemCount');
                const count = articles ? articles.length : 0;
                itemCountDiv.textContent = `Nombre d'articles en stockage local : ${count}`;
            }).catch(err => {
                console.error('Erreur lors de la récupération du nombre d’articles', err);
            });
        }

        // ---------- Chargement des données ----------
        function loadData() {
            const messageDiv = document.getElementById('message');
            messageDiv.style.color = 'blue';
            messageDiv.textContent = 'Chargement des données en cours...';

            fetch('api.php')
                .then(response => response.json())
                .then(data => {
                    localforage.setItem('articles', data).then(() => {
                        messageDiv.style.color = 'green';
                        messageDiv.textContent = 'Données chargées avec succès.';
                        updateItemCount();
                        populateCategorySelect(data);
                        if (isDataVisible) {
                            showLocalData();
                        } else {
                            refreshCurrentView();
                        }
                    }).catch(err => {
                        messageDiv.style.color = 'red';
                        messageDiv.textContent = 'Erreur de stockage local.';
                        console.error('Erreur de stockage local', err);
                    });
                })
                .catch(err => {
                    messageDiv.style.color = 'red';
                    messageDiv.textContent = 'Erreur lors de la récupération des données.';
                    console.error('Erreur lors de la récupération des données', err);
                });
        }

        // ---------- Catégories ----------
        function populateCategorySelect(data) {
            const categorySelect = document.getElementById('categorySelect');
            categorySelect.innerHTML = '<option value="">-- Sélectionner une catégorie --</option>';
            const categoriesCount = {};

            data.forEach(article => {
                if (article.categories) {
                    const categories = article.categories.split(',');
                    categories.forEach(cat => {
                        const trimmedCat = cat.trim();
                        if (trimmedCat) {
                            categoriesCount[trimmedCat] = (categoriesCount[trimmedCat] || 0) + 1;
                        }
                    });
                }
            });

            const categoriesList = Object.keys(categoriesCount).sort();
            categoriesList.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = `${cat} (${categoriesCount[cat]})`;
                categorySelect.appendChild(option);
            });
        }

        function filterByCategory() {
            const selectedCategory = (document.getElementById('categorySelect').value || '').toLowerCase();
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            if (!selectedCategory) {
                resultsDiv.innerHTML = '<p>Veuillez sélectionner une catégorie.</p>';
                return;
            }
            localforage.getItem('articles').then(articles => {
                if (!articles || articles.length === 0) {
                    resultsDiv.innerHTML = '<p>Aucune donnée disponible. Veuillez charger les données.</p>';
                    return;
                }
                const results = articles.filter(article => {
                    if (article.categories) {
                        const categories = article.categories.toLowerCase().split(',');
                        return categories.includes(selectedCategory);
                    }
                    return false;
                });
                displayResultsByLocation(results);
            }).catch(err => {
                console.error('Erreur lors de la récupération des articles', err);
            });
        }

        // ---------- Vider ----------
        function clearData() {
            localforage.removeItem('articles').then(() => {
                const messageDiv = document.getElementById('message');
                messageDiv.style.color = 'green';
                messageDiv.textContent = 'Les données ont été supprimées du stockage local.';
                updateItemCount();
                if (isDataVisible) {
                    toggleLocalData();
                }
            }).catch(err => {
                console.error('Erreur lors de la suppression des données', err);
            });
        }

        // ---------- Afficher/Masquer Données Locales ----------
        function toggleLocalData() {
            if (isDataVisible) {
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = '';
                document.getElementById('toggleButton').textContent = 'Afficher les données locales';
                isDataVisible = false;
            } else {
                showLocalData();
                document.getElementById('toggleButton').textContent = 'Masquer les données locales';
                isDataVisible = true;
            }
        }

        // ---------- Table HTML (avec suffixe) ----------
        function buildTableHTML(items, suffix = '') {
            let table = '<table>';
            table += '<tr><th>ID Article Abarak</th><th>Code-barres</th><th>Nom</th><th>Prix (€)</th><th>Catégories</th></tr>';
            items.forEach(article => {
                const id = appendSuffixToValue(article.id_article_abarak, suffix);
                const code = appendSuffixToValue(article.code_barre, suffix);
                const nom = appendSuffixToValue(article.nom, suffix);
                const prix = appendSuffixToValue(article.prix, suffix); // affichage suffixé demandé
                const cats = appendSuffixToValue(article.categories || '', suffix);
                table += `<tr>
                        <td>${id}</td>
                        <td>${code}</td>
                        <td>${nom}</td>
                        <td>${prix}</td>
                        <td>${cats}</td>
                    </tr>`;
            });
            table += '</table>';
            return table;
        }

        // ---------- Affichage des données locales selon la localisation ----------
        function showLocalData() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            localforage.getItem('articles').then(articles => {
                if (!articles || articles.length === 0) {
                    resultsDiv.innerHTML = '<p>Aucune donnée locale disponible. Veuillez charger les données.</p>';
                    return;
                }
                const loc = getSelectedLocation();
                if (loc === '4') {
                    // Afficher les 3 listes
                    resultsDiv.innerHTML += '<h3>Liste 1</h3>';
                    resultsDiv.innerHTML += buildTableHTML(articles, '');
                    resultsDiv.innerHTML += '<h3>Liste 2</h3>';
                    resultsDiv.innerHTML += buildTableHTML(articles, ' 2');
                    resultsDiv.innerHTML += '<h3>Liste 3</h3>';
                    resultsDiv.innerHTML += buildTableHTML(articles, ' 3');
                } else {
                    const suffix = getSuffixForLocation(loc);
                    resultsDiv.innerHTML = buildTableHTML(articles, suffix);
                }
            }).catch(err => {
                console.error('Erreur lors de la récupération des articles', err);
            });
        }

        // ---------- Upload image / OCR (inchangé) ----------
        function uploadImage() {
            const fileInput = document.getElementById('priceImage');
            const articleId = document.getElementById('articleId').value;
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            formData.append('article_id', articleId);

            fetch('upload.php', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Prix mis à jour : ${data.price} €`);
                    } else {
                        alert(`Erreur : ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Erreur :', error);
                });
        }

        // ---------- Recherche ----------
        function searchArticle() {
            const query = (document.getElementById('searchInput').value || '').toLowerCase();
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            localforage.getItem('articles').then(articles => {
                if (!articles || articles.length === 0) {
                    resultsDiv.innerHTML = '<p>Aucune donnée disponible. Veuillez charger les données.</p>';
                    return;
                }
                const results = articles.filter(article => (article.nom || '').toLowerCase().includes(query));
                displayResultsByLocation(results);
            }).catch(err => {
                console.error('Erreur lors de la récupération des articles', err);
            });
        }

        // ---------- Affichage résultats (paragraphe) avec suffixe ----------
        function displayResults(results, suffix = '') {
            const resultsDiv = document.getElementById('results');
            if (!results || results.length === 0) {
                resultsDiv.innerHTML += '<p>Aucun article trouvé.</p>';
                return;
            }
            results.forEach(article => {
                const nom = appendSuffixToValue(article.nom, suffix);
                const prix = appendSuffixToValue(article.prix, suffix);
                const cats = appendSuffixToValue(article.categories || '', suffix);
                resultsDiv.innerHTML += `<p>${nom} - ${prix}€ - Catégorie : ${cats}</p>`;
            });
        }

        // ---------- Dispatcher selon localisation pour résultats filtrés/recherchés ----------
        function displayResultsByLocation(results) {
            const loc = getSelectedLocation();
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            if (loc === '4') {
                resultsDiv.innerHTML += '<h3>Liste 1</h3>';
                displayResults(results, '');
                resultsDiv.innerHTML += '<h3>Liste 2</h3>';
                displayResults(results, ' 2');
                resultsDiv.innerHTML += '<h3>Liste 3</h3>';
                displayResults(results, ' 3');
            } else {
                displayResults(results, getSuffixForLocation(loc));
            }
        }

        // ---------- Rafraîchir la vue active quand la localisation change ----------
        function refreshCurrentView() {
            if (isDataVisible) {
                showLocalData();
                return;
            }
            const category = document.getElementById('categorySelect').value;
            const searchQ = document.getElementById('searchInput').value;
            if (category) {
                filterByCategory();
            } else if (searchQ) {
                searchArticle();
            } else {
                // Pas de vue active : ne rien afficher, mais on laisse la localisation persistée
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = '';
            }
        }

        // ---------- Init ----------
        window.onload = function () {
            Promise.resolve(loadLocalisationFromStorage())
                .then(() => {
                    updateItemCount();
                    const messageDiv = document.getElementById('message');
                    messageDiv.textContent = 'Application prête.';
                })
                .catch(() => {
                    updateItemCount();
                    const messageDiv = document.getElementById('message');
                    messageDiv.textContent = 'Application prête.';
                });
        };
    </script>
</body>

</html>